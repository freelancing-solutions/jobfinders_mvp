// Notifications Schema - Notification System Models
// This file contains notification management and delivery models

// Core notification storage with persistence
model Notification {
  id              String   @id @default(cuid())
  userId          String   @map("user_id")
  type            String   // application_status, new_job, application_received, job_match, email_campaign, system_announcement
  channel         String   @default("in_app") // in_app, email, sms, push
  title           String
  message         String
  data            Json?    // Additional notification data
  priority        String   @default("normal") // low, normal, high, urgent
  status          String   @default("pending") // pending, sent, delivered, failed, read
  readAt          DateTime? @map("read_at")
  deliveredAt     DateTime? @map("delivered_at")
  failureReason   String?  @map("failure_reason")
  retryCount      Int      @default(0) @map("retry_count")
  maxRetries      Int      @default(3) @map("max_retries")
  scheduledFor    DateTime? @map("scheduled_for")
  expiresAt       DateTime? @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  user            User     @relation(fields: [userId], references: [uid], onDelete: Cascade)
  deliveryLogs    NotificationDeliveryLog[]
  analyticsEvents AnalyticsEvent[]
  userJourneys    UserJourney[]

  @@index([userId])
  @@index([type])
  @@index([channel])
  @@index([status])
  @@index([priority])
  @@index([scheduledFor])
  @@index([createdAt])
  @@map("notifications")
}

// User notification preferences and settings
model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique @map("user_id")

  // Channel preferences
  emailEnabled          Boolean  @default(true) @map("email_enabled")
  smsEnabled            Boolean  @default(false) @map("sms_enabled")
  pushEnabled           Boolean  @default(true) @map("push_enabled")
  inAppEnabled          Boolean  @default(true) @map("in_app_enabled")

  // Notification type preferences
  applicationUpdates    Boolean  @default(true) @map("application_updates")
  newJobAlerts          Boolean  @default(true) @map("new_job_alerts")
  jobMatches            Boolean  @default(true) @map("job_matches")
  applicationReceived   Boolean  @default(true) @map("application_received")
  systemAnnouncements   Boolean  @default(true) @map("system_announcements")
  marketingEmails       Boolean  @default(false) @map("marketing_emails")

  // Delivery timing preferences
  quietHoursStart       String?  @map("quiet_hours_start") // HH:MM format
  quietHoursEnd         String?  @map("quiet_hours_end")   // HH:MM format
  timezone              String   @default("UTC")
  frequency             String   @default("immediate") // immediate, hourly, daily, weekly

  // Contact information
  phoneNumber           String?  @map("phone_number")
  alternateEmail        String?  @map("alternate_email")

  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")

  // Relationships
  user                  User     @relation(fields: [userId], references: [uid], onDelete: Cascade)

  @@map("notification_preferences")
}

// Email templates for different notification types
model NotificationTemplate {
  id              String   @id @default(cuid())
  name            String   @unique
  type            String   // application_status, new_job, job_match, welcome, etc.
  channel         String   // email, sms, push
  subject         String?  // For email templates
  htmlContent     String?  @map("html_content")
  textContent     String   @map("text_content")
  variables       Json?    // Template variables schema
  isActive        Boolean  @default(true) @map("is_active")
  version         Int      @default(1)
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@index([type])
  @@index([channel])
  @@index([isActive])
  @@map("notification_templates")
}

// Delivery tracking and analytics
model NotificationDeliveryLog {
  id              String   @id @default(cuid())
  notificationId  String   @map("notification_id")
  channel         String
  status          String   // sent, delivered, failed, bounced, opened, clicked
  provider        String?  // sendgrid, twilio, firebase, etc.
  providerMessageId String? @map("provider_message_id")
  errorCode       String?  @map("error_code")
  errorMessage    String?  @map("error_message")
  metadata        Json?    // Provider-specific data
  attemptedAt     DateTime @default(now()) @map("attempted_at")
  deliveredAt     DateTime? @map("delivered_at")
  openedAt        DateTime? @map("opened_at")
  clickedAt       DateTime? @map("clicked_at")

  // Relationships
  notification    Notification @relation(fields: [notificationId], references: [id], onDelete: Cascade)

  @@index([notificationId])
  @@index([channel])
  @@index([status])
  @@index([attemptedAt])
  @@map("notification_delivery_logs")
}

// Email campaigns and bulk messaging
model NotificationCampaign {
  id              String   @id @default(cuid())
  name            String
  description     String?
  type            String   // email_campaign, system_announcement, promotional
  templateId      String?  @map("template_id")
  targetAudience  Json     @map("target_audience") // User selection criteria
  status          String   @default("draft") // draft, scheduled, sending, completed, cancelled
  scheduledFor    DateTime? @map("scheduled_for")
  startedAt       DateTime? @map("started_at")
  completedAt     DateTime? @map("completed_at")
  totalRecipients Int      @default(0) @map("total_recipients")
  sentCount       Int      @default(0) @map("sent_count")
  deliveredCount  Int      @default(0) @map("delivered_count")
  failedCount     Int      @default(0) @map("failed_count")
  openedCount     Int      @default(0) @map("opened_count")
  clickedCount    Int      @default(0) @map("clicked_count")
  createdBy       String   @map("created_by")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Relationships
  analytics       CampaignAnalytics[]

  @@index([status])
  @@index([scheduledFor])
  @@index([createdBy])
  @@index([createdAt])
  @@map("notification_campaigns")
}

// Campaign analytics for detailed campaign performance
model CampaignAnalytics {
  id              String   @id @default(cuid())
  campaignId      String   @map("campaign_id")
  date            DateTime @default(now())
  channel         String
  segment         String?  // User segment if applicable
  totalSent       Int      @default(0) @map("total_sent")
  totalDelivered  Int      @default(0) @map("total_delivered")
  totalFailed     Int      @default(0) @map("total_failed")
  totalOpened     Int      @default(0) @map("total_opened")
  totalClicked    Int      @default(0) @map("total_clicked")
  totalBounced    Int      @default(0) @map("total_bounced")
  totalUnsubscribed Int    @default(0) @map("total_unsubscribed")
  revenue         Float?   // Revenue attributed to this campaign
  conversions     Int      @default(0) // Conversion events

  // Relationships
  campaign       NotificationCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@unique([campaignId, date, channel, segment])
  @@index([campaignId])
  @@index([date])
  @@index([channel])
  @@map("campaign_analytics")
}

// Notification analytics and metrics (aggregated daily)
model NotificationAnalytics {
  id                    String   @id @default(cuid())
  date                  DateTime @default(now())
  channel               String
  totalSent             Int      @default(0) @map("total_sent")
  totalDelivered        Int      @default(0) @map("total_delivered")
  totalFailed           Int      @default(0) @map("total_failed")
  totalOpened           Int      @default(0) @map("total_opened")
  totalClicked          Int      @default(0) @map("total_clicked")
  deliveryRate          Float    @default(0.0) @map("delivery_rate")
  openRate              Float    @default(0.0) @map("open_rate")
  clickRate             Float    @default(0.0) @map("click_rate")
  averageDeliveryTime   Float    @default(0.0) @map("average_delivery_time") // in seconds
  bounceRate            Float    @default(0.0) @map("bounce_rate")
  unsubscribeRate       Float    @default(0.0) @map("unsubscribe_rate")

  @@unique([date, channel])
  @@index([date])
  @@index([channel])
  @@map("notification_analytics")
}